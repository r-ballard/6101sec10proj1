---
title: "Final: Ice Cream"
author: "Alonso Romero, Russ Ballard"
# date: "today"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r init, include=F}
# The package "ezids" (EZ Intro to Data Science) includes a lot of the helper functions we developed for the course. 
# Some of the frequently used functions are loadPkg(), xkabledply(), xkablesummary(), uzscale(), etc.
# Once installed, load the library.
library(ezids)

set.seed(20052)

pkg_vector <- c("ggplot2",
                "gridExtra",
                "tidyverse",
                "stringi",
                "scales",
                "lubridate",
                "zoo",
                "dplyr",
                "DescTools")

invisible(lapply(pkg_vector, loadPkg))
```


```{r setup, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
# knitr::opts_chunk$set(include = F)
# knitr::opts_chunk$set(echo = TRUE)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

# The Ice Cream Dataset

Our project uses an Ice Cream dataset that was retrieved from Kaggle from the following website: "https://www.kaggle.com/datasets/tysonpo/ice-cream-dataset/data". The dataset contains a product and review datasets for 4 brands of ice cream, Ben & Jerry's, Häagen-Dazs, Talenti, and Breyers. For the purposes of this project, we will be using a combined dataset provided by the author that combines all the products and reviews of all brands into their respective csv file.

```{r decompress_data, echo=FALSE}

projwd <- getwd()

datadir <- "data"
rawdir <- "raw"
zipf <- "icecream.zip"
outf <- "icecream"

zippath <- file.path(projwd, datadir, rawdir, zipf, fsep='/')
outpath <- file.path(projwd, datadir, rawdir, outf, fsep='/')

unzip(zippath, exdir=outpath)
```
The above chunk abstracts the filepath of the raw `icecream.zip` compressed directory to `data/raw/icecream.zip` within the working directory, which is presumed to be the top level of the repo. The .zip is extracted

```{r load colorbrew}
brandcolorpath <- file.path(projwd, datadir, "processing/brandcolors.csv")
brandcolordf <- data.frame(read.csv(brandcolorpath,
                           header=TRUE,
                           sep=",",
                           quote="\"",
                           colClasses=c("brand"="character",
                                        "color"="character",
                                        "fill"="character")))

brandcolordf
```
A metadata table containing color choices for the different brands has been created, this abstraction can be used for setting colors in the subsequent visualizations for standardizaiton and ease of implementation. 

```{r load_products}
prodcombpath <- file.path(outpath, "combined/products.csv")
products <- data.frame(read.csv(prodcombpath,
                            header=TRUE,
                            sep=",",
                            quote="\"",
                            colClasses=c("brand"="factor",
                                          "key"="character",
                                          "name"="character",
                                          "subhead"="character",
                                          "description"="character",
                                          "rating"="numeric",
                                          "rating_count"="numeric",
                                          "ingredients"="character")))

```

```{r load_reviews}

reviewpath <- file.path(outpath, "combined/reviews.csv")
reviews <- data.frame(read.csv(reviewpath,
                            header=TRUE,
                            sep=",",
                            quote="\"",
                            na.strings=c("","NA"),
                            colClasses=c("brand"="factor",
                                          "key"="character",
                                          "author"="character",
                                          "date"="character",
                                          "stars"="numeric",
                                          "title"="character",
                                          "helpful_yes"="numeric",
                                          "helpful_no"="character",
                                          "text"="character",
                                          "taste"="numeric",
                                          "ingredients"="numeric",
                                          "texture"="character",
                                          "likes"="character")))

reviews$date <- as.Date(reviews$date,'%Y-%m-%d')
```

```{r}
nrow_products <- nrow(products)
nrow_reviews <- nrow(reviews)
```

The combined product dataset contains `r nrow_products` data points, and the combined reviews dataset contains `r nrow_reviews` data points.

For the `products.csv` file, the variables in the dataset are:

* `brand`: brand keyword that categorizes each product to its respective brand
* `key`: the primary key that contains a numerical value and the brand keyword
* `name`: the product name
* `subhead`: simple description of the product (used for Ben & Jerry's products only)
* `description`: detailed description of the product
* `rating`: a star rating scale with a range of 1.0 to 5.0
* `rating_count`: amount of ratings for the product
* `ingredients`: ingredient list of the product

For the `reviews.csv` file, the variables in the dataset are:

* `brand`: brand keyword that categorizes each product to its respective brand
* `key`: foreign key that matches to key in `products.csv`
* `author`: the username of the reviewer
* `date`: date that review was posted
* `stars`: reviewer rating of the product
* `title`: reviewer-created title of their review
* `helpful_yes`: amount of users that found the review helpful
* `helpful_no`: amount of users that found the review not helpful
* `text`: the text-based review
* `taste`: reviewer rating of product taste in a range of 1.0 to 5.0  (For Häagen-Dazs products only)
* `ingredients`: reviewer rating of product ingredients in a range of 1.0 to 5.0 (For Häagen-Dazs products only)
* `texture`: reviewer rating of product texture in a range of 1.0 to 5.0 (For Häagen-Dazs products only)
* `likes`: reviewer likes from a preset list to choose from (For Häagen-Dazs products only)

Regarding the dataset, there are important considerations that the author provides for users. First, "the collection of reviews on the brand websites may not be representative of overall opinion, i.e. there may be review censoring or presence of fake reviews meant to help/harm the image of the brand" (Pond, 2020). In order to combat this, the author, "intentionally chose brands that host some negative reviews on their website" (Pond, 2020). Next, the author acknowledges the parent companies of each of the brands. "Ben & Jerry's, Breyers, and Talenti are all owned by Uniever. Häagen-Dazs is owned by Froneri" (Pond, 2020). It is also important to note that, "Talenti is distinguished from the other brands as they produce gelato" (Pond, 2020).

```{r echo=FALSE}
colnames(products)[1:8]=c("Brand", "ProductID", "ProductName", "Subhead","ProductDescription", "Rating", "RatingCount", "Ingredients")
# xkabledplyhead(products, title = "Product header rows")

colnames(reviews)[1:13]=c("Brand", "ProductID", "Username", "Date", "Stars", "Title", "Helpful", "Not Helpful", "Review", "Taste", "Ingredients", "Texture", "Likes")
# xkabledplyhead(reviews, title = "Review header rows")
```

```{r results='markup'}
xkablesummary(products, title = "Summary of the products dataset")
xkablesummary(reviews, title = "Summary of the reviews dataset")
```

```{r productindicators}
products$HAS_VANILLA <- as.factor(as.integer(grepl(pattern = "VANILLA", x = products$Ingredients)))
products$HAS_ORGANIC <- as.factor(as.integer(grepl(pattern = "ORGANIC", x = products$Ingredients)))
products$HAS_CARAMEL <- as.factor(as.integer(grepl(pattern = "CARAMEL", x = products$Ingredients)))

fruitvec <- c("RASPBERR","CHERR","BLUEBERR","BANANA")
products$HAS_FRUIT <- as.factor(as.integer(grepl(pattern=paste(fruitvec,collapse="|"), x=products$Ingredients)))

chocvec <- c("CHOCOLAT","COCO")
products$HAS_CHOCOLATE <- as.factor(as.integer(grepl(pattern=paste(chocvec,collapse="|"), x=products$Ingredients)))

products$IS_BAR <- as.factor(as.integer(grepl(pattern = "BAR", x = products$ProductName) | 
                                grepl(pattern = "BAR", x = products$Subhead)))
```

```{r joinproductreview}

productreview <- left_join(reviews,
                           products %>% select(ProductID,
                                                 HAS_CARAMEL,
                                                 HAS_CHOCOLATE,
                                                 HAS_FRUIT,
                                                 HAS_VANILLA,
                                                 HAS_ORGANIC,
                                                 IS_BAR),
                           by="ProductID", multiple="all")
```


Using `grepl` we are able to implement regex matching to create additional binary indicator fields for ingredients in the `products` dataframe. 

# Exploratory Data Analysis

#### For this project we will be addressing the question: Should Breyers introduce a new product of a flavor that would outperform their competitors, or improve an existing product to help boost their average rating?

We will explore the Ice Cream dataset by creating graphs, performing tests, and finding the measures of central tendency and variation. First, we'll look at the overall dataset, and then the individual datasets of each of the four brands.

```{r}
library(ggplot2)
ggplot(data=products, aes(Rating)) +
  geom_histogram(col='blue', fill='lightblue', alpha=0.7) +
    labs(x="Rating", y="Frequency") +
    labs(title="Ice Cream Product Rating Histogram using `ggplot`") +
    theme(plot.title = element_text(hjust = 0.5))
```

This histogram shows the overall ratings of all ice-cream products across all 4 brands of ice-cream. We can see that there is a high frequency of ratings within the 4 - 5 star range. Based on the histogram above, we can see a left skewed distribution. To further test the skewness, we will perform a QQ plot.

```{r}
sd.ratings <- sd(products$Rating)
mean.ratings <- mean(products$Rating)
sd.ratings
mean.ratings
```

The mean of the data above is `r mean.ratings` and the standard deviation is `r sd.ratings`

```{r}
qqnorm(products$Rating, main="QQ plot of Product Ratings")
qqline(products$Rating)
```

Based on the Q-Q plot above, we see that the graph is displaying a left skew as most of the data points are within the third to fifth sample quantile. Therefore this graph displays that the dataset does not present a normal distribution. To further test for normality, the Shapiro-Wilk test is conducted below.

```{r results='markup'}
shapiro.test(products$Rating)
```

For the Shapiro-Wilk test, we are given the following hypotheses:

* `Null Hypothesis`: The sample comes from a normally distributed population
* `Alternative Hypothesis`: The sample does not come from a normally distributed population

Based on the results of the test, the p-value is less than the significance level of 0.05, which means that we reject the null hypothesis and conclude that the data from the sample does not come from a normally distributed population.

#### Measures of Central Tendency

With the combined dataset, we will calculate the mean, median, and mode for this dataset.

```{r echo=FALSE}
mean.rating <- mean(products$Rating)
median.rating <- median(products$Rating)
mode.rating <- names(table(products$Rating))[table(products$Rating) == max(table(products$Rating))]
```

* `Mean`: `r mean.rating`
* `Median`: `r median.rating`
* `Mode`: `r mode.rating`

Based on these results, this further proves that the data is left skewed since the mean is the lowest value followed by the median and the the mode being the highest value.

#### Measures of Variation

With the combined dataset, we will calculate the range, mean deviation, standard deviation, and variance.

```{r echo=FALSE}
range.rating <- range(products$Rating)
md.rating <- mean(abs(products$Rating - mean.rating))
sd.rating <- sd(products$Rating)
variance.rating <- var(products$Rating)
```

* `Range`: `r range.rating`
* `Mean Deviation`: `r md.rating`
* `Standard Deviation`: `r sd.rating`
* `Variance`: `r variance.rating`

With the dataset, we are given data that ranges between `r range.rating[2] - range.rating[1]` ratings points between the lowest rating and the highest rating. The mean deviation shows us that on average, each value in the dataset is about `r mean(abs(products$Rating - mean.rating))` away from the mean. The standard deviation shows us that the data is dispersed `r sd.rating` points in relation to the mean. The variance shows that each data point is about `r var(products$Rating)` points away from the mean and other data points in the dataset.

```{r}
z4rating <- (4 - mean.ratings)/sd.ratings
```
We will generate a z-score for a rating of 4 in our distribution.

By taking the value of 4 and subtracting it with the mean `r mean.ratings` and dividing everything by the standard deviation of `r sd(products$Rating)`, we get the z score of `r z4rating`.

Based on this result, we can determine that a rating of 4 lays within the range of the mean and one standard deviation to the left in our distribution.

```{r}
pnorm.rating <- pnorm(z4rating)
```

By taking the `pnorm()` function, `r pnorm.rating` is the probability that a rating of `4` is under the distribution.

```{r, message=FALSE, warning=FALSE, results='markup'}
loadPkg("Hmisc")
describe(products$Rating)
```
Describing the overall data by using the the `describe()` function to highlight the ratings column.

```{r contingencyplot}

brandrating_contingency_table<-table(productreview$Brand,productreview$Stars, dnn=c("Brand", "Star Rating"))

brandrating_contingency_table
prop.table(brandrating_contingency_table,margin=1)

mosaicplot(brandrating_contingency_table)
```

Above is the contingency table for the brand product-reviews. We can see that the proportions are as described in the histogram, largely 5's for all brands. Interestingly, Breyer's appears to have a larger proportion of 1's than the other groups.

### Breyers

Breyers is committed on using high quality ingredients. Breyers "start with high ingredients like colors and flavors from natural sources and sustainably farmed vanilla. [They] partner with American farmers for 100% Grade A milk and cream that comes from cows not treated with artificial growth hormones" ("About Breyers History", n.d.).
 
```{r breyershist}
breyers_data <- subset(products, Brand == "breyers")

breycol <- brandcolordf$color[brandcolordf$brand=="breyers"]
breyfill <-brandcolordf$fill[brandcolordf$brand=="breyers"]

ggplot(breyers_data, aes(Rating)) +
  geom_histogram(col=breycol, fill=breyfill, alpha=0.7) +
  labs(x="Rating", y="Frequency") +
  labs(title="Breyers' Product Rating Histogram using `ggplot`") +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r breyerssummarystat}
mean.breyratings <- mean(breyers_data$Rating)
sd.breyratings <- sd(breyers_data$Rating)
```

From the graph, the breyers data is similar to the histogram of Ben & Jerry's and the combined dataset. The graph also displays a left-skewed distribution.
The mean of the data above is `r mean.breyratings` and the standard deviation is `r sd.breyratings`

```{r breyersprodratings}
#color and fill are inverted here for readability
ggplot(breyers_data, aes(x=ProductID, y=Rating)) +
  geom_point(col=breyfill, fill=breycol, alpha=0.7) +
  labs(x="ProductID", y='Rating') +
  labs(title="Ratings for each individual Breyers products") + 
  theme(axis.text.x = element_text(angle=90, hjust=1, size = 5)) +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r breyersextrema}
# Finding the highest rated products
max_rating_index <- which(breyers_data$Rating == max(breyers_data$Rating))
max_productname <- breyers_data$ProductName[max_rating_index]

# Finding the lowest rated products
min_rating_index <- which(breyers_data$Rating == min(breyers_data$Rating))
min_productname <- breyers_data$ProductName[min_rating_index]
```

Based from the graph, the highest rated Breyers product: `r max_productname`

```{r, echo=FALSE, results='markup'}
breyers_top <- subset(productreview, ProductID == "41_breyers")
breyers_top_reviews <- breyers_top[, c("Review")]
breyers_top_reviews
```

Above are the two reviews of Breyers' Oreo Snack Cups 10ct. Both reviews praise on how the ice cream is portioned out.

Based from the graph, the lowest rated Breyers product: `r min_productname`

```{r, echo=FALSE, results='markup'}
breyers_low <- subset(productreview, ProductID == "66_breyers")
breyers_low_reviews <- breyers_low[, c("Review")]
head(breyers_low_reviews)
```

Above are the first 6 reviews of Breyers' Layered Dessert S'mores. Customers complained on how the product does not taste like s'mores. Specifically, the marshmellows and graham crackers was either lacking or tasted awful, and the overall taste of what customers expected for s'mores did not meet their expectations. Though some customers actually like the product.

#### Measures of Central Tendency

With the Breyers data subset, we will calculate the mean, median, and mode for this dataset.

```{r echo=FALSE}
mean.breyrating <- mean(breyers_data$Rating)
median.breyrating <- median(breyers_data$Rating)
mode.breyrating <- names(table(breyers_data$Rating))[table(breyers_data$Rating) == max(table(breyers_data$Rating))]
```

* `Mean`: `r mean.breyrating`
* `Median`: `r median.breyrating`
* `Mode`: `r mode.breyrating`

The measures of central tendency show that the average rating is `r mean.breyrating`, the median rating is `r median.breyrating`, with a score of `r mode.breyrating` appearing most often. Again like the other brands, these values prove that the data displays a left skewed distribution.

#### Measures of Variation

With the Breyers data subset, we will calculate the range, mean deviation, standard deviation, and variance.

```{r echo=FALSE}
range.breyrating <- range(breyers_data$Rating)
md.breyrating <- mean(abs(breyers_data$Rating - mean.breyrating))
sd.breyrating <- sd(breyers_data$Rating)
variance.breyrating <- var(breyers_data$Rating)
```

* `Range`: `r range.breyrating`
* `Mean Deviation`: `r md.breyrating`
* `Standard Deviation`: `r sd.breyrating`
* `Variance`: `r variance.breyrating`

With the Breyers dataset, the data ranges `r range.breyrating[2] - range.breyrating[1]` data points from the lowest point to the highest point. The mean deviation here shows us that on average, each value in the dataset is about `r md.breyrating` points away from the mean. The standard deviation shows us that the data is dispersed `r sd.breyrating` points in relation to the mean. The variance shows that each data point is about `r variance.breyrating` points away from the mean and other data points in the dataset.

## Addressing the issue

```{r results='markup'}
summary_by_brand <- aggregate(Rating ~ Brand, data = products, FUN = summary)

summary_by_brand
```

Here we see that the average rating for the Breyers brand is the lowest among the other brands in the dataset with an average rating of 3.96 compared to a rating of 4.00+ for the other brands.

```{r results='markup'}
breyers_products <- subset(products, Brand == "breyers")
sorted_breyers <- breyers_products[order(breyers_products$Rating), ]
lowest_breyers <- head(sorted_breyers[, c("ProductID", "ProductName", "Rating", "RatingCount")], n = 5)

lowest_breyers
```

Here we see the lowest 5 rated products that Breyers offers.

In order for Breyers to help boost their average ratings. We would need to see the products that the other brands are struggling with to see where they should target.

```{r results='markup'}
bj_products <- subset(products, Brand == "bj")
sorted_bj <- bj_products[order(bj_products$Rating), ]
lowest_bj <- head(sorted_bj[, c("ProductID", "ProductName", "Rating", "RatingCount")], n = 5)

hd_products <- subset(products, Brand == "hd")
sorted_hd <- hd_products[order(hd_products$Rating), ]
lowest_hd <- head(sorted_hd[, c("ProductID", "ProductName", "Rating", "RatingCount")], n = 5)

tal_products <- subset(products, Brand == "talenti")
sorted_tal <- tal_products[order(tal_products$Rating), ]
lowest_tal <- head(sorted_tal[, c("ProductID", "ProductName", "Rating", "RatingCount")], n = 5)

lowest_bj
lowest_hd
lowest_tal
```

Here we see that there is similarities of products across brands such as the flavors of Chocolate Chip Cookie Dough and variations of a coffee flavor.

Lets focus on the product, Chocolate Chip Cookie Dough.

What are the common complaints that arose from the reviews?
```{r}
#install.packages("tm")
library(tm)
```

```{r}
cccd_breyers <- reviews[reviews$ProductID == "49_breyers", "Review"]
corpus <- Corpus(VectorSource(cccd_breyers))

corpus <- tm_map(corpus, tolower)
corpus <- tm_map(corpus, removePunctuation)
corpus <- tm_map(corpus, removeNumbers)
corpus <- tm_map(corpus, removeWords, stopwords("english"))
corpus <- tm_map(corpus, removeWords, c("ice", "cookie", "dough", "cream", "breyers", "like", 'just', 'chocolate', 'chip', 'will', 'one'))
corpus <- tm_map(corpus, stripWhitespace)

dtm <- DocumentTermMatrix(corpus)
matrix <- as.matrix(dtm)

word_freq <- sort(colSums(matrix), decreasing=TRUE)

word_freq_df <- data.frame(word = names(word_freq), freq = word_freq, stringsAsFactors = FALSE)

barplot(word_freq_df[1:20,]$freq, las=2, names.arg=word_freq_df[1:20,]$word, col='lightgreen', main='Frequently Used Words in Breyers Reviews', ylab= 'Word Frequencies')
```

```{r}
cccd_bj <- reviews[reviews$ProductID == "50_bj", "Review"]
corpus <- Corpus(VectorSource(cccd_bj))

corpus <- tm_map(corpus, tolower)
corpus <- tm_map(corpus, removePunctuation)
corpus <- tm_map(corpus, removeNumbers)
corpus <- tm_map(corpus, removeWords, stopwords("english"))
corpus <- tm_map(corpus, removeWords, c("ice", "cookie", "dough", "cream", "core", "like", 'just', 'chocolate', 'chip','ben', "'s", 'one'))
corpus <- tm_map(corpus, stripWhitespace)

dtm <- DocumentTermMatrix(corpus)
matrix <- as.matrix(dtm)

word_freq <- sort(colSums(matrix), decreasing=TRUE)

word_freq_df <- data.frame(word = names(word_freq), freq = word_freq, stringsAsFactors = FALSE)

barplot(word_freq_df[1:20,]$freq, las=2, names.arg=word_freq_df[1:20,]$word, col='black', main="Frequently Used Words in Ben & Jerry's Reviews", ylab= 'Word Frequencies')
```

```{r}
cccd_tal <- reviews[reviews$ProductID == "9_talenti", "Review"]
corpus <- Corpus(VectorSource(cccd_tal))

corpus <- tm_map(corpus, tolower)
corpus <- tm_map(corpus, removePunctuation)
corpus <- tm_map(corpus, removeNumbers)
corpus <- tm_map(corpus, removeWords, stopwords("english"))
corpus <- tm_map(corpus, removeWords, c("ice", "cookie", "dough", "cream", "gelato", "like", 'just', 'chocolate', 'chip', 'one', 'talenti', 'will'))
corpus <- tm_map(corpus, stripWhitespace)

dtm <- DocumentTermMatrix(corpus)
matrix <- as.matrix(dtm)

word_freq <- sort(colSums(matrix), decreasing=TRUE)

word_freq_df <- data.frame(word = names(word_freq), freq = word_freq, stringsAsFactors = FALSE)

barplot(word_freq_df[1:20,]$freq, las=2, names.arg=word_freq_df[1:20,]$word, col='chocolate', main="Frequently Used Words in Talenti Reviews", ylab= 'Word Frequencies')
```


# References

About Breyers History. (N.d.). Breyers. Retrieved March 12, 2024, from https://www.breyers.com/us/en/about.html

About Us. (N.d.). Häagen Dazs. Retrieved March 12, 2024, from https://www.icecream.com/us/en/brands/haagen-dazs/about

Our Process. (N.d.). Talenti. Retrieved March 12, 2024, from https://www.talentigelato.com/us/en/our-process.html

Our Values, Activism, and Mission. (N.d.). Ben & Jerry's. Retrieved March 12, 2024, from https://www.benjerry.com/values

Pond, T. (2020, Sept). Ice Cream Dataset. Kaggle. Retrieved March 11, 2024, from https://www.kaggle.com/datasets/tysonpo/ice-cream-dataset/data

